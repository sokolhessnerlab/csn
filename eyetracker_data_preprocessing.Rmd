---
title: "Eyetracker Data Preprocessing"
author: "Ari Dyckovsky"
output:
  md_document:
    variant: markdown_github
---

# Eyetracker Data Preprocessing

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  strip.white = TRUE,
  tidy = TRUE,
  highlight = TRUE
)
```

## Load packages

```{r, libraries, message=FALSE}
library(tidyverse)
```

## File path definitions

```{r}
root_path <- "/Volumes/shlab/Projects/CSN/data/extracted/eyetracker"
event_csv <- "fevent.csv"
sample_csv <- "fsample.csv"
ioevent_csv <- "ioevent.csv"
recordings_csv <- "recordings.csv"

id_prefix <- "CSN"
id_length <- 3
min_id <- 1
max_id <- 57
```

## Loading methods

```{r}
get_path_to_id <- function(id) {
  padded_id <- stringr::str_pad(id, 3, pad = "0")
  participant_id <- stringr::str_c(id_prefix, padded_id)
  return(file.path(root_path, participant_id))
}

get_id_vector <- function() {
  # Gets a vector of id integers for participants
  id_vector <- c()
  for (i in min_id:max_id) {
    if ( dir.exists(get_path_to_id(i)) ) {
      id_vector <- c(id_vector, i)
    }
  }
  return(id_vector)
}

load_all_etd_by_filename_csv <-function(id_vector, filename_csv = sample_csv) {
  # Loads all eyetracking data of given filename across participants
  etd_list <- list()
  for (id in id_vector) {
    path_to_etd <- file.path(get_path_to_id(id), filename_csv)
    etd_list[[id]] <- readr::read_csv(path_to_etd)
  }
  return(etd_list)
}

id_vector <- get_id_vector()
```

## Load each data for all participants

```{r, message=FALSE}
etd_events <- load_all_etd_by_filename_csv(id_vector, event_csv)
etd_ioevents <- load_all_etd_by_filename_csv(id_vector, ioevent_csv)
etd_recordings <- load_all_etd_by_filename_csv(id_vector, recordings_csv)
# TAKES A LOT OF TIME TO LOAD. UNCOMMENT IF WANTED.
#etd_samples <- load_all_etd_by_filename_csv(id_vector, sample_csv)
```

### Recordings data methods using `etd_recordings` list

```{r}
get_duration <- function(id) {
  # Duration from highest start time and lowest start time, in minutes
  summary <- etd_recordings[[id]] %>% 
    summarize(duration = (max(time) - min(time)) / (1000*60) ) %>%
    unnest(cols = c())
  return(summary$duration)
}

get_durations <- function(id_vector) {
  # Durations in minutes for all participants events' data
  durations <- c()
  for (i in id_vector) {
    durations <- c(durations, get_duration(i))
  }
  return(durations)
}

get_recording_time_matrix <- function(id_vector, dimensional_reducer = 1) {
  # Get a built matrix with a row for each id in id_vector, with four
  # times per row. Optional dimensional reducer to achieve times in seconds, minutes.
  n_ids <- length(id_vector)
  n_recordings <- 1 + length(etd_recordings[[id_vector[[1]]]]$time)
  recording_time_matrix <- matrix(NA, nrow=n_ids, ncol=n_recordings)
  
  for (i in 1:n_ids) {
    id <- id_vector[i]
    recording_time_matrix[i,] <- c(id, (etd_recordings[[id]]$time / dimensional_reducer))
  }
  
  return(recording_time_matrix)
  
}

get_recording_time_df <- function(id_vector, dimensional_reducer = 1) {
  # Get dataframe using matrix of ids and times from recordings. Optional
  # dimensional reducer to achieve times in seconds, minutes.
  m <- get_recording_time_matrix(id_vector, dimensional_reducer)
  df <- as.data.frame(m)
  recording_time_df_cols <- c("id", "calibration", "validation", "task", "revalidation")
  colnames(df) <- recording_time_df_cols
  
  return(df)
  
}
```

### Look at recording times

Can retrieve all recording moments across participants by seconds or minutes. In seconds, the difference between revalidation and task time, then subtracting 3600, provides an idea of how much "overtime" the task went.

```{r}
recording_time_df_seconds <- get_recording_time_df(id_vector, 1000)
recording_time_df_minutes <- get_recording_time_df(id_vector, 1000 * 60)

sort(recording_time_df_seconds$revalidation - recording_time_df_seconds$task - 3600)
```

### Begin looking at participant CSN001

#### Time between calibration and validation

```{r}
csn001_events <- etd_events[[1]]
recording_time_df <- get_recording_time_df(id_vector)

csn001_recordings <- recording_time_df %>% filter(id == 1)
csn001_recordings$calibration

csn001_events %>% 
  filter(sttime > csn001_recordings$calibration) %>% 
  relocate(message)
```
```{r}
(1006763	- 881874) / 1000
```
